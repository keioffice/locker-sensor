# ESP32 ロッカーセンサーシステム

VL53L0X ToFセンサーを使用した荷物預かり検知システム

## 📋 目次

- [システム概要](#システム概要)
- [主な機能](#主な機能)
- [ハードウェア構成](#ハードウェア構成)
- [LED動作仕様](#led動作仕様)
- [セットアップ](#セットアップ)
- [使い方](#使い方)
- [Web設定画面](#web設定画面)
- [MQTT通信](#mqtt通信)
- [トラブルシューティング](#トラブルシューティング)

---

## システム概要

ESP32マイコンとVL53L0X ToFセンサーを使用し、ロッカー内の荷物の預かり・取り出しを自動検知するIoTシステムです。

### 動作フロー

```
1. 物体検知開始 → 緑LED 1秒点滅
2. 10秒継続 → 預かり状態（赤LED 点灯）+ MQTT送信
3. 物体が離れる → 取り出し検知（赤LED 1秒点滅）
4. 10秒継続 → 取り出し完了（緑LED 点灯）+ MQTT送信
```

---

## 主な機能

### ✨ 検知機能
- **距離測定**: VL53L0Xセンサーで最大2m（設定可能）
- **移動平均フィルター**: 5回の測定値を平均化し、ばらつきを軽減
- **預かり判定**: 設定時間（デフォルト10秒）継続で預かり状態
- **取り出し判定**: 設定時間（デフォルト10秒）継続で取り出し完了
- **取り出しキャンセル**: 取り出し中に物体が戻れば自動キャンセル

### 🌐 ネットワーク機能
- **DHCP/固定IP対応**: Web画面でラジオボタン切り替え
- **MQTT通信**: 状態変化を即座にブローカーに送信
- **DDNS対応**: MQTTブローカーにドメイン名指定可能
- **Web設定画面**: ブラウザから各種パラメータを設定

### 💡 LED表示
- **状態可視化**: 検知中・預かり中・取り出し中を色と点滅で表示
- **接続状態表示**: WiFi/MQTT接続エラー時は赤緑交互点滅

---

## ハードウェア構成

### 必要な部品

| 部品 | 型番/仕様 | 用途 |
|------|----------|------|
| マイコン | ESP32開発ボード | メイン制御 |
| 距離センサー | VL53L0X ToFセンサー | 物体検知 |
| LED（赤） | 3mm/5mm LED | 状態表示 |
| LED（緑） | 3mm/5mm LED | 状態表示 |
| 抵抗 | 330Ω × 2 | LED電流制限 |
| 電源 | USB 5V | ESP32電源 |

### 配線図

```
VL53L0X → ESP32
  VIN   → 3.3V
  GND   → GND
  SDA   → GPIO21 (I2C SDA)
  SCL   → GPIO22 (I2C SCL)

LED → ESP32
  赤LED → GPIO33 (+ 330Ω抵抗) → GND
  緑LED → GPIO32 (+ 330Ω抵抗) → GND

初期化スイッチ（タクトスイッチまたはジャンパーピン）
  GPIO4 ←→ GND (初期化時のみ接続)
```

### ピン割り当て一覧

| GPIO | 用途 | 説明 |
|------|------|------|
| GPIO21 | I2C SDA | VL53L0Xセンサー通信 |
| GPIO22 | I2C SCL | VL53L0Xセンサー通信 |
| GPIO32 | 緑LED制御 | 状態表示（空き・検知中） |
| GPIO33 | 赤LED制御 | 状態表示（預かり中・取り出し中） |
| GPIO4 | 初期化入力 | LOW=初期化、HIGH=通常起動 |

---

## LED動作仕様

| 状態 | 緑LED | 赤LED | 説明 |
|------|-------|-------|------|
| **空き** | 点灯 | 消灯 | 荷物なし、利用可能 |
| **検知中** | 1秒点滅 | 消灯 | 物体を検知（預かり判定待ち） |
| **預かり状態** | 消灯 | 点灯 | 荷物預かり中 |
| **取り出し検知中** | 消灯 | 1秒点滅 | 取り出し判定待ち |
| **接続エラー** | 赤緑交互点滅 | 赤緑交互点滅 | WiFi/MQTT未接続 |

---

## セットアップ

### 1. 開発環境

- **PlatformIO**: VSCode拡張機能を推奨
- **Arduino IDE**: 互換性あり

### 2. ライブラリ

以下のライブラリが必要です（PlatformIOは自動インストール）:

```ini
lib_deps =
    adafruit/Adafruit VL53L0X
    knolleary/PubSubClient
    bblanchon/ArduinoJson
```

### 3. 初回書き込み

1. ESP32を接続
2. PlatformIOでビルド＆アップロード
3. シリアルモニタ（115200bps）で起動を確認

---

## 使い方

### 初期設定

#### デフォルト値で起動する場合

1. **GPIO4をGNDに接続**してESP32を起動
2. 赤緑LED同時点滅3回 → デフォルト値にリセット完了
3. GPIO4を外して再起動

#### Web設定画面から設定する場合

1. ESP32起動後、シリアルモニタでIPアドレスを確認
   ```
   設定画面URL: http://192.168.0.252
   ```

2. ブラウザでアクセス

3. 設定項目を入力して保存

4. 「設定を更新」ボタンをクリック

5. ESP32を再起動して設定を反映

### 運用

1. **通常起動**: 電源ON → 設定値で起動
2. **DHCP使用**: Web画面でDHCP選択（テザリング対応）
3. **固定IP使用**: Web画面で固定IP選択（社内LAN）

---

## Web設定画面

### ネットワーク設定

| 項目 | 説明 | 例 |
|------|------|-----|
| WiFi SSID | 接続先SSID | `TP-Link_2G` |
| WiFi パスワード | WiFiパスワード | `********` |
| **IPアドレス取得方法** | DHCP/固定IPを選択 | - |
| IPアドレス | 固定IP（固定IP選択時） | `192.168.0.252` |
| ゲートウェイ | ゲートウェイ（固定IP選択時） | `192.168.0.1` |
| サブネットマスク | サブネット（固定IP選択時） | `255.255.255.0` |

### MQTT設定

| 項目 | 説明 | 例 |
|------|------|-----|
| MQTTブローカー | IPアドレスまたはURL | `192.168.0.251` または `mqtt.example.com` |
| MQTTポート | ポート番号 | `1883` |
| MQTTクライアントID | クライアントID | `ESP32_Locker_1` |
| MQTTトピック | Publishトピック | `locker/sensor` |

### センサー設定

| 項目 | 説明 | デフォルト値 |
|------|------|-------------|
| 検知距離 (mm) | 物体検知する距離 | `100` |
| 預かり判定時間 (秒) | 預かり状態になるまでの時間 | `10` |
| 取り出し判定時間 (秒) | 取り出し完了までの時間 | `10` |

---

## MQTT通信

### 送信データ形式（JSON）

```json
{
  "lockerId": 1,
  "occupied": true,
  "distance": 256,
  "timestamp": 12345,
  "detecting": false
}
```

| フィールド | 型 | 説明 |
|-----------|-----|------|
| `lockerId` | int | ロッカーID（固定: 1） |
| `occupied` | bool | 預かり状態（true: 預かり中, false: 空き） |
| `distance` | int | 現在の距離（mm） |
| `timestamp` | long | タイムスタンプ（ミリ秒） |
| `detecting` | bool | 検知中フラグ |

### 送信タイミング

- **状態変化時**: 即座に送信
  - 預かり開始時
  - 取り出し完了時
- **定期送信**: 30秒ごと（生存確認）

---

## トラブルシューティング

### 問題: Web設定が反映されない

**原因**: EEPROM構造が古い
**解決**: GPIO4をGNDに接続して再起動 → デフォルト値にリセット

### 問題: 距離測定が不安定

**原因**: センサーの測定範囲外、または反射率が低い
**解決**:
- 検知距離を調整（Web設定画面で変更可能）
- 推奨範囲: 100mm〜400mm
- 移動平均フィルター（5回平均）で自動平滑化済み

### 問題: MQTT接続失敗 (rc=-2)

**原因**: ブローカーに接続できない
**解決**:
- MQTTブローカーのIPアドレス/URLを確認
- ネットワーク接続を確認
- ファイアウォール設定を確認（ポート1883）

### 問題: WiFi接続失敗

**原因**: SSID/パスワードが間違っている
**解決**:
- Web設定画面で再設定
- または GPIO4 → GNDでデフォルト値にリセット

### 問題: 起動時にダウンロードモードになる

**原因**: GPIO0（旧バージョン）が使用されている
**解決**: 最新版ではGPIO4に変更済み

---

## 技術仕様

### センサー

- **型番**: VL53L0X ToF (Time of Flight)
- **測定範囲**: 最大2m
- **測定精度**: ±3%
- **測定間隔**: 100ms（1秒間に10回）
- **測定タイミング**: 200ms（高精度・長距離モード）

### 通信

- **WiFi**: 802.11 b/g/n (2.4GHz)
- **MQTT**: v3.1.1
- **Web**: HTTP (ポート80)

### 電源

- **動作電圧**: 5V (USB)
- **消費電流**: 約200mA（WiFi通信時）

---

## ライセンス

このプロジェクトはMITライセンスの下で公開されています。

---

## 開発履歴

### v1.0.0 (2025-10-06)
- 初期リリース
- VL53L0Xセンサー対応
- LED動作仕様実装
- 移動平均フィルター実装
- DHCP/固定IP対応
- Web設定画面実装
- MQTT通信実装

---

## お問い合わせ

- **GitHub**: https://github.com/keioffice/locker-sensor
- **Email**: kajimura@keioffice.net
